<!DOCTYPE html>
<meta charset="utf-8">

<!-- dzslides core
    __  __  __       .  __   ___  __
   |  \  / /__` |    | |  \ |__  /__`
   |__/ /_ .__/ |___ | |__/ |___ .__/ core :â‚¬

The default files are not supposed to be edited. Not that you can't.
-->
<script src="default/slide.js"></script>
<link rel="stylesheet" href="default/style.css">

<!-- Maybe a font from http://www.google.com/webfonts ? -->
<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet'>
<!-- Your Style -->
<link rel="stylesheet" href="custom.css">

<title>Bash best and worst practices</title>

<section>
    <h1>Bash</h1>
    <h2>best and worst practices</h2>
    <footer>by Philipp Martis and Andreas Nordal</footer>
</section>

<section>
	<h1>Why care</h1>
	<p class="next">Common myths:</p>
	<ul>
	<li><i>LOL, shellscripts are old-school</i></li>
	<li><i>I'm not writing them</i></li>
	</ul>
</section>

<section>
	<ul>
	<li><i>LOL, shellscripts are old-school</i></li>
	<li><i>I'm not writing them</i></li>
	</ul>
	<hr/>
	<ol>
	<li class="next">Define shellscript programming</li>
	<li class="next">Where you find them</li>
	<li class="next">How <i>not</i> to write one</li>
	</ol>
</section>

<section>
	<header><center>What signifies a shellscript language?</center></header>
	<code>&gt;Â 1+1
1+1: Command not found.
&gt;Â calc '1+1'
2</code>
	<p>Programs as building blocks<p>
</section>

<section>
	<header><center>What defines a shellscript language?</center></header>
	<code>&gt;Â 1+1
1+1: Command not found.
&gt;Â calc '1+1'
2</code>
	<p>A language for running other programs.<p>
</section>

<section>
	<header><center>Where shellscripts are found</center></header>
	<p>The okay:</p>
	<ul>
	<li>Personal automation</li>
	<li>Your typical test script</li>
	<li>Build systems</li>
	<ul>
	<li>Makefiles</li>
	<li>Dockerfiles</li>
	<li>Openembedded</li>
	</ul>
	<li>Every script that runs over ssh</li>
	</ul>
	<ul>
</section>

<section>
	<header><center>Where shellscripts are found</center></header>
	<p>The bad:</p>
	<li>Hidden in other programs</li>
	<ul>
	<li>C/C++: <tt>system("")</tt></li>
	<li>Python: <tt>subprocess.call("", shell=True)</tt></li>
	</ul>
	<p class="next">The ugly:</p>
	<li class="next">Generating a shellscript at runtime (often with improper quoting)</li>
	<ul class="next">
	<li>C++: <tt>std::string cmd("./script.py ") + filename; system(cmd);</tt></li>
	<li>Python: <tt>subprocess.call("./script.py " + filename, shell=True)</tt></li>
	</ul>
</section>

<section>
	<header><center>How to not generate shellscripts at runtime</center></header>
	<p>Two insights:</p>
	<ul>
	<li>A command is fundamentally an array (<tt>argv</tt>)</li>
	<li>The set of environment variables is also an array.</li>
	</ul>
	<p class="next">â†’ The command <i>line</i> is an illusion.</p>
	<p class="next">â†’ If you are doing string processing, you are doing it wrong.</p>
</section>

<section>
	<header><center>How to not do this?</center></header>
	<p>Generating a shellscript at runtime (with improper quoting)</p>
	<code>cmd = "LANG=C.UTF-8 ./script.py " + filename
subprocess.call(cmd, shell=True)</code>
	<hr>
	<p class="next">Not invoking the shell</p>
	<code class="next">cmd = ["./script.py", filename]
env = {"LANG": "C.UTF-8"}
subprocess.call(cmd, env=env)</code>
</section>

<section>
	<header><center>How to not do this?</center></header>
	<code>auto cmd = std::string("LANG=C.UTF-8 ./script.py ") + filename;
system(cmd);</code>
	<hr>
	<code class="next">const char* cmd[] = {
    "./script.py",
    filename,
    nullptr
};
const char* env[] = {
    "LANG=C.UTF-8",
    nullptr
};
posix_spawn(â€¦, cmd[0], â€¦, â€¦, cmd, env)</code>
</section>

<section>
	<p>The driver's license of Bash scripting:</p>
	<h1><b>"</b>Quoting<b>"</b></h1>
</section>

<section>
	<p>Must be quoted [1/2]:</p>
	<h1><b>"</b>$var<b>"</b></h1>
	<footer>Variable expansion</footer>
</section>

<section>
	<p>Must be quoted [2/2]:</p>
	<h1><b>"</b>$(cmd)<b>"</b></h1>
	<h1 class="next"><b>"</b>`cmd`<b>"</b></h1>
	<footer>Command substitution</footer>
</section>

<section>
	<h1>Why quote?</h1>
	<pre>$var</pre>
	<pre>$(cmd)</pre>
	<pre>`cmd`</pre>
</section>

<section>
	<h1>Why quote?</h1>
	<p class="evil">ðŸ”¥ Evil implicit behavior ðŸ”¥</p>
	<ol>
	<li>Word splitting</li>
	<li>Filename expansion</li>
	</ol>
</section>

<section>
	<h2>Warm-up</h2>
	<p>Word splitting</p>
	<code>file="La Bouche/Be my lover.mp3"
rm $file</code>
	<code class="next">â†’ <span class="bg">rm</span> <span class="bg">La</span> <span class="bg">Bouche/Be</span> <span class="bg">my</span> <span class="bg">lover.mp3</span></code>
</section>

<section>
	<h2>Warm-up</h2>
	<p>Filename expansion</p>
	<code>dir="Sagittarius_A*"
rm -rf $dir</code>
	<code class="next">â†’ <span class="bg">rm</span> <span class="bg">-rf</span> <span class="bg">Sagittarius_AB</span> <span class="bg">Sagittarius_And_Other_Dwarf_Galaxies</span> <span class="bg">Sagittarius_A*</span></code>
</section>

<section>
	<h2>Quiz</h2>
	<code>file="; rm -rf /"
cat $file</code>
	<code class="next">â†’ <span class="bg">cat</span> <span class="bg">;</span> <span class="bg">rm</span> <span class="bg">-rf</span> <span class="bg">/</span></code>
	<p class="next">Just word splitting &amp; filename expansion. Bash is not a macro language.</p>
</section>


<section>
	<h1>Small pitfalls</h1>
</section>

<section>
	<p>Positional args</p>
	<code>#!/bin/bash
echo "$1"</code>
	<code class="next">#!/bin/bash
echo "$10"</code>
	<code class="next">#!/bin/bash
echo "${10}"</code>
</section>

<section>
	<p>"$<b>{</b>10<b>}</b>" â€¦ But why?</p>
	<p class="next">There are 2 types of variable names:</p>
	<ol>
	<li class="next">An identifier: <code>[_a-zA-Z][_a-zA-Z0-9]*</code></li>
	<li class="next">A non-identifier single character: <code>[^_a-zA-Z]</code></li>
	</ol>
</section>

<section>
	<h2>Quiz</h2>
	<p>Where does the variable name end?</p>
	<code>einstein() { echo "$1ball"; }
einstein foot
</code>
	<code class="next">â†’ <span class="bg">football</span>
â†’ </code>
</section>

<section>
	<h2>Quiz</h2>
	<p>Where does the variable name end?</p>
	<code>{
    toffi=cof
    toffifee=airline
    toffifee_fee=Bryan
    toffifee_fee-fee=Air
} 2>/dev/null

echo "$toffifee_fee-fee"
echo "$toffi""fee_fee-fee"</code>
</section>

<section>
	<code>{
    <b>toffi</b>=cof
    toffifee=airline
    <b>toffifee_fee</b>=Bryan
    toffifee_fee-fee=Air
} 2>/dev/null

echo "<b>$toffifee_fee</b>-fee"
echo "<b>$toffi</b>""fee_fee-fee"</code>
	<code class="next">â†’ <span class="bg">Bryan-fee</span>
â†’ <span class="bg">coffee_fee-fee</span>
â†’ </code>
</section>

<section>
	<h2>Escaping and ` `</h2>
	<br>
	<br>
	<p class="next">Use <red>` `</red> only for simple things, if at all!</p>
</section>

<section>
	<h2>Quiz</h2>
	<p>How do you rewrite the following, using only one <inline-code>echo</inline-code>:</p>
	<code>echo "` echo "$(echo 'h\\i')" `"</code>
	<code class="next">echo 'h\i'  # or echo "h\\i"</code>
</section>

<section>
	<h2>Escaping and ` `</h2>
	<p>Being syntactically surrounded by <inline-code>` `</inline-code>
	   is enough to halve the number of <inline-code>\\</inline-code>s.
	</p>
	<p class="next"><inline-code>\n</inline-code> stays <inline-code>\n</inline-code>.
	</p>
</section>

<section>
	<h2>Variable shadowing</h2>
	<p>Consider</p>
	<code>greet() {
    name="$1"
    for s in Ð¿Ñ€Ð¸Ð²ÐµÑ‚ Hello Hei; do
        echo "$s, $name!"
    done
}

read -p "What's your name? " s
greet "$s"
echo "I like the name $s!"
</code>
</section>

<section>
	<h2>Variable shadowing</h2>
	<p>Correct:</p>
	<code>greet() {
    <green>declare</green> name="$1" <green>s</green>
    for s in Ð¿Ñ€Ð¸Ð²ÐµÑ‚ Hello Hei; do
        echo "$s, $name!"
    done
}

read -p "What's your name? " s
greet "$s"
echo "I like the name $s!"
</code>
</section>

<section>
	<h2>Variable shadowing</h2>
	<p>Good: ðŸ™‚</p>
	<code>greet() {
    declare name="$1" <green>hello</green>
    for <green>hello</green> in Ð¿Ñ€Ð¸Ð²ÐµÑ‚ Hello Hei; do
        echo "<green>$hello</green>, $name!"
    done
}

<green>declare name</green>
read -p "What's your name? " <green>name</green>
greet <green>"$name"</green>
echo "I like the name <green>$name</green>!"
</code>
</section>

<section>
	<h2>Variable visibility</h2>
	<p>Consider</p>
	<code>declare max="" line
get_values | while read -r line; do
    declare val="`parse "$line"`"
    if higher "$val" "$max"; then
        max="$val"
    fi
done
</code>
</section>

<section>
	<h2>Variable visibility</h2>
	<br>
	<p><inline-code>max</inline-code> isn't changed, since the whole loop
           runs in a subshell introduced by <inline-code>|</inline-code>.
	</p>
</section>

<section>
	<h2>Variable visibility</h2>
	<p>General solution:</p>
        <code>declare max="" line
while read -r line; do
    declare val="`parse "$line"`"
    if higher "$val" "$max"; then
        max="$val"
    fi
done <green>< <(get_values)</green>
</code>
</section>

<section>
	<h2>Variable visibility</h2>
	<p>Cleaner:</p>
        <code>print_max() {
    declare max="" line
    while read -r line; do
        update_max "$line"
    done
    echo "$max"
}

max="` get_values | print_max `"
</code>
</section>

<section>
	<h2>Variable contents</h2>
	<p>Arbitrary values: ðŸ™‚</p>
        <code>print_max() {
    declare max="" line
    while read -r line; do
        update_max "$line"
    done
    <green>printf '%s\n'</green> "$max"
}

max="` get_values | print_max `"
</code>
</section>



<section>
	<h2>Use what Bash provides!</h2>
	<h3>Input and output</h3>
	<ul>
		<li class="next"><inline-code>&></inline-code>: Redirect stdout and stderr at once
	</ul>
	<br>
	<ul>
		<li class="next"><inline-code><<-'EOF'</inline-code>: Redirect stdin to yield
			the upcoming lines, until <inline-code>EOF</inline-code>
		<ul>
			<li class="next">... ignoring leading tabs (<inline-code>-</inline-code>)
			<li class="next">... literally (<inline-code>''</inline-code>)
		</ul>
	</ul>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3>Input and output</h3>
	<ul>
		<li class="next"><inline-code><<< asdf</inline-code>: Redirect stdin to yield
			<inline-code>asdf</inline-code>
	</ul>
	<br>
	<ul>
		<li class="next"><inline-code><(git show)</inline-code>: Usable like a file
			containing the output of <inline-code>git show</inline-code>
	</ul>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3>Parameter expansion</h3>
	<ul>
		<li><inline-code>${s%%/*}</inline-code>: <inline-code>s</inline-code>,
			without trailing <inline-code>/*</inline-code>
		<li><inline-code>${s#*/}</inline-code>: <inline-code>s</inline-code>,
			without shortest leading <inline-code>*/</inline-code>
		<li><inline-code>${s/a/b}</inline-code>: <inline-code>s</inline-code>,
			replacing first <inline-code>a</inline-code> with <inline-code>b</inline-code>
		<li><inline-code>${s//a/b}</inline-code>: <inline-code>s</inline-code>,
			replacing every <inline-code>a</inline-code> with <inline-code>b</inline-code>
		<li><inline-code>${!s}</inline-code>: Content of variable named <inline-code>"$s"</inline-code>
	</ul>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3><inline-code>shopt -s</inline-code></h3>
	<ul>
		<li><inline-code>dotglob</inline-code>: Include hidden files when globbing
		<li><inline-code>nullglob</inline-code>: Expand unsuccessful globs to empty string
		<li><inline-code>nocasematch</inline-code>: Ignore case
			(<b>not in</b> <inline-code>test</inline-code>/<inline-code>[</inline-code>!)
	</ul>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3><inline-code>set</inline-code></h3>
	<ul>
		<li><inline-code>-x</inline-code>: Echo executed commands
		<li><inline-code>-e</inline-code>: Exit on errors (covered later)
		<li><inline-code>-u</inline-code>: Treat unset variables as errors (and exit)
		<li><inline-code>-o pipefail</inline-code>: Pipe fails if <b>any</b> of its commands fail
	</ul>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3>Grouping: <inline-code>{ }</inline-code></h3>
	<code>cleanup || { essential_cleanup; exit 1; }</code>
	<code class="next">{ echo "[configuration]"; make_config; } > file.conf</code>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3>Subshells: <inline-code>( )</inline-code></h3>
	<medium>Changes don't affect parent shell</medium>
	<code class="next">( set -x; cmd lots of parameters )</code>
	<code class="next">if ( shopt -s nocasematch; [[ "$s" == "yes" ]] )</code>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3>Extended conditionals: <inline-code>[[Â ]]</inline-code></h3>
	<code class="next">shopt -s nocasematch; [[Â "a" == "A" ]]</code>
	<code class="next">[[Â "a" > "b" && (-f "file" || ! -f "file") ]]</code>
	<code class="next">[[ "a" =~ ^a(bc)*$ ]]</code>
</section>

<section>
	<h2>Use what Bash provides!</h2>
	<h3>Arithmetic conditionals: <inline-code>((Â ))</inline-code></h3>
	<code class="next">(( $? == expected_code ))</code>
	<code class="next">(( 0 < 1 ** 0 && ! (1 << 1 & 2) ))</code>
	<code class="next">(( i += 2 ))</code>
	<code class="next">for (( i = 0; i < n; ++i ))</code>
</section>

<section>
	<h2>set -e</h2>
	<p>Some object fiercly to it</p>
	<br>
	<ul>
		<li>They have <a href=https://wiki.bash-hackers.org/scripting/obsolete>good</a>
	                      <a href=http://mywiki.wooledge.org/BashFAQ/105>points</a>
		<li>There are also good points for it:
	        <ul>
			<li class="next">Less code: more readable and less error-prone
			<li class="next">Catches most (programming) errors
		</ul>
	</ul>
</section>

<section>
	<h2>set -e</h2>
	<p>One example of the tribulations with <inline-code>set -e</inline-code></p>
	<code>f() {
    ( set -e; false; echo "D'oh!" )
}
f && false</code>
</section>

<section>
	<h2>set -e</h2>
	<small>
		The <inline-code>&&</inline-code> thwarts <inline-code>set -e</inline-code>,
		even inside a subshell inside a function!
	</small>
	<div class="next">
		<br>
		<p>Solution:</p>
		<code>f <green>& wait $!</green> && false</code>
	</div>
</section>










<section>
    <p>Some random text: But I've never been to the moon! You can see how I lived before I met you. Also Zoidberg.
    I could if you hadn't turned on the light and shut off my stereo.</p>
</section>

<section>
    <h3>An incremental list</h3>
    <ul>
      <li class="next">Item 1
      <li class="next">Item 2
      <li class="next">Item 3
        <ul>
          <li class="next"> Item 3.1
          <li class="next"> Item 3.2
        </ul>
      <li class="next">Item 4
    </ul>
    <div role="note">Some notes. They are only visible using onstage shell.</div>
</section>

<section>
    <h3>More incrementals</h3>
    <p class="next">Not only list elements can appear incrementally</p>
    <p><mark class="next">Styles</mark> can be incremental
       <mark class="next">too</mark></p>
</section>

<section>
    <h3>Even more incrementals</h3>
    <p>
      <span class="next" next-order="3">They</span>
      <span class="next" next-order="5">can</span>
      <span class="next" next-order="2">even</span>
      <span class="next" next-order="1">appear</span>
      <span class="next" next-order="7">in</span>
      <span class="next" next-order="4">any</span>
      <span class="next" next-order="6">order</span>
      <span class="next" next-order="8">!</span>
    </p>
</section>

<section>
  <blockquote>
    Who's brave enough to fly into something we all keep calling a death sphere?
  </blockquote>
  <details>
    <p>In the onstage shell, notes scroll rather than overflow:</p>
    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac dui eu est feugiat lacinia sit amet nec leo. Mauris eu ipsum leo. Nulla mi odio, cursus sed sollicitudin non, fringilla id magna. Suspendisse sit amet posuere elit. Maecenas iaculis, turpis a placerat imperdiet, libero lorem feugiat nisi, nec tincidunt diam nibh sit amet massa. Vestibulum quis adipiscing tellus. Maecenas sollicitudin sodales pulvinar. Donec dui ipsum, bibendum facilisis consequat interdum, tempus ut mauris. Aliquam ut dolor nec odio scelerisque bibendum quis in neque. Aliquam dui dui, pulvinar quis fermentum quis, gravida eu augue. Nunc tristique dolor a urna pulvinar bibendum. Curabitur mollis cursus neque, in scelerisque metus porta non. Donec tempor enim in nibh vestibulum et convallis nisi malesuada. Duis ut lectus sed metus venenatis porttitor id pharetra quam. Suspendisse sapien turpis, ornare in molestie et, gravida eget turpis.
    </p>
  </details>
</section>

<section>
    <h1>Part two</h1>
</section>

<section>
    <figure> <!-- Figures are used to display images and videos fullpage -->
      <img src="http://placekitten.com/g/800/600">
      <figcaption>An image</figcaption>
    </figure>
    <div role="note">Kittens are so cute!</div>
</section>

<section>
    <figure> <!-- Videos are automatically played -->
      <video src="http://videos.cdn.mozilla.net/brand/Mozilla_Firefox_Manifesto_v0.2_640.webm" poster="http://www.mozilla.org/images/about/poster.jpg"></video>
      <figcaption>A video</figcaption>
    </figure>
</section>

<section>
    <h1>End!</h1>
</section>

<div id="progress-bar"></div>
